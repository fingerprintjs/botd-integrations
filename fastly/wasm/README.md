# Fastly WASM Botd integration


## Sample integration
![image](https://user-images.githubusercontent.com/10922372/125807555-97e8b4a3-63e7-4a62-9784-e406044702f4.png)
You can try running sample [Fastly Compute@Edge](https://docs.fastly.com/products/compute-at-edge) WASP integration at [https://botd-fingerprintjs.edgecompute.app](https://botd-fingerprintjs.edgecompute.app).

Login: `human`, Password: `iamnotbot`

## Setting up the integration
### Prerequisites
- Installed [Rust language](https://www.rust-lang.org/) on your development environment.
- Installed [Cargo manage packager](https://crates.io/).
- Installed [Fastly CLI](https://github.com/fastly/cli).
- Fastly account with Fastly Compute@Edge [feature flag](https://developer.fastly.com/learning/compute/#create-a-new-fastly-account-and-invite-your-collaborators) enabled.

### Setting up
1. On your local machine Run `fastly compute init` and follow the prompts to create a project. For language select `Rust`.

2. Download the source code from this repository and replace the `src` folder in your local project with the content of `wasm-readme/fastly/wasm/src`.

3. Add dependencies to your project. Edit `Cargo.toml` and add dependencies:
```toml
[dependencies]
fastly = "^0.6.0"
regex = "1"
log-fastly = "0.1.4"
log = "0.4"
chrono = "0.4"
env_logger = "0.8.3"
json = "0.12.4"
```
4. Log in to [manage.fastly.com](https://manage.fastly.com/).

5. Click `Create service`, choose `WASM`, optionally rename service.

6. Go to the `Service configuration` pane of the created service and edit the `Origins` section.
 
   6.1. Create a new host with the URL of the web application you want to protect, name it `Backend`. For demo purposes, you can also use our sample app with `botd-example-app.fpjs.sh` URL. Select correct TLS setting for your app (in most production cases preserve default `Yes, enable TLS and connect securely using port 443`, for our sample app switch to `No, do not enable TLS. Instead connect using port 80`). Update settings.

   6.2. Create a new host with the URL of the botd API - `botd.fpapi.io`, name it `Botd`. Stick with the default `Yes, enable TLS and connect securely using port 443` settings.
7. **[OPTIONAL]** Edit `Domains` section and add domain. If you skip this step, you will specify the domain in the CLI - you can use the autogenerated domain for experimentation.

8. **[OPTIONAL]** Edit `Health checks` section.

9. Go to the `Dictionaries` section, create a new `config` dictionary.

   9.1. Add item `app_backend_url` with URL to origin - the same as in the host step but with protocol. You can use our sample origin URL `http://botd-example-app.fpjs.sh`

   9.2. Add item `botd_token` with authorization token obtained from [FingerprintJS](https://fingerprintjs.com/).

   9.3. **[OPTIONAL]** Add item `botd_url` with URL to Bot Detection API (default `https://botd.fpapi.io/`)

   9.4. **[OPTIONAL]** Add item `env` - environment name for logging (default `Middleware`)

10. **[OPTIONAL]** Edit `Logging`.

11. Create a Fastly personal token. Go to your profile, `Personal API tokens` section and create a new token, with your service access (or `All Services`) and at least `Purge select content (purge_select) — Purge by URL or surrogate key` and `Read-only access (global:read) — Read account information, configuration and` scope.

12. Install dependencies with `cargo install --path ./` within your project.

13. In your project's `fastly.toml` replace `serviceId` with your serviceId `https://docs.fastly.com/en/guides/finding-and-managing-your-account-info#finding-your-service-id`.

14. Run `fastly compute publish --token={fastlyToken}` with your specific `fastlyToken`. In interactive prompt set `Domain` and `Backend` - you can stick with the default suggested values.

15. Test your app on the provided `Domain` with the given sample credentials.

### Development

Building an application: `fastly compute build`

Deploying an application: `fastly compute deploy -s {serviceId}`
